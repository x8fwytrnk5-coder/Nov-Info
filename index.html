<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InfoKľúč taxikára</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body {
    margin: 0;
    padding: 0;
    font-family: Arial;
    background: #fff;
    color: #000;
    overflow: hidden;
}

#container {
    display: flex;
    height: 100vh;
    width: 100vw;
}

/* PANEL */
#leftPanel {
    width: 0px; /* zasunutý stav */
    max-width: 400px;
    background: #f4f4f4;
    border-right: 1px solid #ccc;
    overflow-y: auto;
    transition: width 0.3s ease;
    padding: 10px;
    box-sizing: border-box;
}

#leftPanel.open {
    width: 35%;
}

#closePanel {
    display: none;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 10px;
}

#leftPanel.open #closePanel {
    display: block;
}

.result {
    background: #fff;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    cursor: pointer;
}

.result:hover {
    background: #e9f1ff;
}

/* MAPA */
#map {
    flex-grow: 1;
    height: 100%;
    width: 100%;
    display: block;
    position: relative; /* kvôli tlačidlu Navigovať */
}

/* NAVIGOVAŤ – v pravom hornom rohu */
#navigateBtn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 12px 18px;
    background: #999; /* neaktívne */
    color: white;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    opacity: 0.5;
    pointer-events: none; /* neklikateľné */
    display: block;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
	z-index: 9999;

}

/* OVLÁDACÍ PANEL HORE */
#topControls {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 999;
    background: rgba(255,255,255,0.9);
    padding: 10px 15px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

select, button {
    padding: 10px;
    font-size: 18px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

button {
    background: #1976d2;
    color: white;
    border: none;
    cursor: pointer;
}

button:active {
    background: #0f5ca8;
}
</style>
</head>

<body>
<div id="container">

    <!-- PANEL S VÝSLEDKAMI -->
    <div id="leftPanel">
        <div id="closePanel">✕</div>
        <div id="results"></div>
    </div>

    <!-- MAPA + NAVIGOVAŤ -->
    <div id="map">
        <div id="navigateBtn">Navigovať</div>
    </div>


<!-- OVLÁDACÍ PANEL HORE -->
<div id="topControls">
    <select id="category">
        <option value="restaurant">Reštaurácie</option>
        <option value="hotel">Ubytovanie</option>
        <option value="doctor">Nájdi lekára</option>
        <option value="monuments">Pamiatky</option>
        <option value="cinema_theatre">Kiná a divadlá</option>
        <option value="mall">Obchod</option>
        <option value="car_repair">Autoservisy</option>
    </select>
    <button onclick="searchPlaces()">Hľadať</button>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// --------------------------------------
// MAPA
// --------------------------------------
let map = L.map('map').setView([48.5, 19.0], 13);
let userMarker = null;
let selectedPlace = null;
let lastSearchTime = 0;

// Stabilný HTTPS tile server kompatibilný s Android WebView
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// --------------------------------------
// SLEDOVANIE POLOHY
// --------------------------------------
function updateLocation() {
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            if (!userMarker) {
                userMarker = L.marker([lat, lon]).addTo(map);
                map.setView([lat, lon], 15);
            } else {
                userMarker.setLatLng([lat, lon]);
            }
        },
        err => {
            console.log("GPS error:", err);
        },
        {
            enableHighAccuracy: true,
            timeout: 10000
        }
    );
}

// aktualizácia každých 5 sekúnd
setInterval(updateLocation, 5000);
updateLocation();

	

// --------------------------------------
// NOMINATIM FALLBACK
// --------------------------------------
const NOMINATIM_SERVERS = [
    "https://nominatim.openstreetmap.org/search",
    "https://nominatim.openstreetmap.fr/search",
    "https://nominatim.kumi.systems/search"
];

async function nominatimSearch(params) {
    for (let server of NOMINATIM_SERVERS) {
        const url = server + "?" + params;

        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 6000);

            const response = await fetch(url, {
                signal: controller.signal,
                headers: { "User-Agent": "TaxiApp/1.0" }
            });

            clearTimeout(timeout);

            if (response.ok) {
                const data = await response.json();
                if (data.length > 0) return data;
            }
        } catch (e) {
            continue;
        }
    }
    return [];
}

// --------------------------------------
// VZDIALENOSŤ
// --------------------------------------
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI/180;
    const dLon = (lon2 - lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1*Math.PI/180) *
              Math.cos(lat2*Math.PI/180) *
              Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// --------------------------------------
// KATEGÓRIE – ROZŠÍRENÉ DOTAZY
// --------------------------------------
const CATEGORY_QUERIES = {
    doctor: [
        "doctor",
        "general practitioner",
        "clinic",
        "ambulance",
        "medical center"
    ],
    monuments: [
        "historic",
        "monument",
        "memorial",
        "castle",
        "ruins",
        "statue"
    ],
    cinema_theatre: [
        "cinema",
        "movie theatre",
        "theatre",
        "kino"
    ],
    restaurant: ["restaurant"],
    hotel: ["hotel"],
    car_repair: ["car repair", "autoservis"]
};

// --------------------------------------
// OBCHODY PODĽA ZNAČKY
// --------------------------------------
const BRAND_QUERIES = [
    "Tesco supermarket",
    "Lidl supermarket",
    "Billa supermarket",
    "COOP Jednota supermarket"
];

async function searchShops(lat, lon) {
    const delta = 0.135; // ~8 km
    const viewbox = [
        lon - delta,
        lat - delta,
        lon + delta,
        lat + delta
    ].join(",");

    let allResults = [];

    for (let q of BRAND_QUERIES) {
        const params = new URLSearchParams({
            format: "json",
            q: q,
            addressdetails: 1,
            extratags: 1,
            namedetails: 1,
            limit: 10,
            bounded: 1,
            viewbox: viewbox
        }).toString();

        const results = await nominatimSearch(params);
        allResults.push(...results);
    }

    return allResults;
}

// --------------------------------------
// HĽADANIE
// --------------------------------------
async function searchPlaces() {
    const now = Date.now();
    if (now - lastSearchTime < 3000) return;
    lastSearchTime = now;

    // deaktivovať tlačidlo Navigovať
    const btn = document.getElementById("navigateBtn");
    btn.style.background = "#999";
    btn.style.opacity = "0.5";
    btn.style.pointerEvents = "none";
    selectedPlace = null;

    // zatvoriť panel
    document.getElementById("leftPanel").classList.remove("open");

    navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        const category = document.getElementById("category").value;

        let results = [];

        if (category === "mall") {
            results = await searchShops(lat, lon);
        } else {
            const queries = CATEGORY_QUERIES[category] || [category];

            const delta = 0.135;
            const viewbox = [
                lon - delta,
                lat - delta,
                lon + delta,
                lat + delta
            ].join(",");

            let all = [];

            for (let q of queries) {
                const params = new URLSearchParams({
                    format: "json",
                    q: q,
                    addressdetails: 1,
                    extratags: 1,
                    namedetails: 1,
                    limit: 10,
                    bounded: 1,
                    viewbox: viewbox
                }).toString();

                const r = await nominatimSearch(params);
                all.push(...r);
            }

            results = all;
        }

        results = results
            .map(r => ({
                ...r,
                distance: getDistance(lat, lon, r.lat, r.lon)
            }))
            .sort((a, b) => a.distance - b.distance)
            .slice(0, 10);

        showResults(results);
    });
}

// --------------------------------------
// PANEL + VÝSLEDKY
// --------------------------------------
function showResults(results) {
    const panel = document.getElementById("leftPanel");
    const list = document.getElementById("results");
    list.innerHTML = "";

    panel.classList.add("open");

    results.forEach(r => {
        const div = document.createElement("div");
        div.className = "result";
        div.innerHTML = `
            <b>${r.display_name}</b><br>
            ${r.distance.toFixed(1)} km
        `;
        div.onclick = () => selectPlace(r);
        list.appendChild(div);
    });
}

document.getElementById("closePanel").onclick = () => {
    document.getElementById("leftPanel").classList.remove("open");
};

// --------------------------------------
// VÝBER MIESTA
// --------------------------------------
function selectPlace(place) {
    selectedPlace = place;

    map.setView([place.lat, place.lon], 17);

    const btn = document.getElementById("navigateBtn");
    btn.style.background = "#1976d2";
    btn.style.opacity = "1";
    btn.style.pointerEvents = "auto";

    document.getElementById("leftPanel").classList.remove("open");
}

// --------------------------------------
// NAVIGOVAŤ
// --------------------------------------
document.getElementById("navigateBtn").onclick = () => {
    if (!selectedPlace) return;

    const url = `https://www.google.com/maps/dir/?api=1&destination=${selectedPlace.lat},${selectedPlace.lon}`;
    window.open(url, "_blank");
};
</script>
</body>
</html>
	
